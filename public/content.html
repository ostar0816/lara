<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSRF Token -->
    <meta name="csrf-token" content="3mWSazMe2H65AB2dVXDDZpOIuC7VytM8QcqJOvFq">

    <title>Larapress | Admin</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <!-- Styles -->
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">

    

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">

    <!-- Ionicons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">

    <!-- Theme style -->
    <link media="all" type="text/css" rel="stylesheet" href="/themes/Admin_Theme/css/AdminLTE.min.css">
    <link media="all" type="text/css" rel="stylesheet" href="/themes/Admin_Theme/css/skins/skin-blue.min.css">
    <link media="all" type="text/css" rel="stylesheet" href="/themes/Admin_Theme/css/sweetalert2.css">
    
    

    <!-- <link rel="stylesheet" href="http://larapress.dev/backend/css/sweetalert2.css"> -->

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,600,700,800" rel="stylesheet">

    <!-- <link media="all" type="text/css" rel="stylesheet" href="/themes/Admin_Theme/css/style.css"> -->
    <link rel="stylesheet" href="http://larapress.dev/themes/Admin_Theme/css/style.css?lnPacaP">

    <!-- Scripts -->
    <script>
        window.Laravel = {"csrfToken":"3mWSazMe2H65AB2dVXDDZpOIuC7VytM8QcqJOvFq"}    </script>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Sortable/1.4.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="/themes/Admin_Theme/js/sweetalert2.js"></script>

</head>
<body class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">
        <header class="main-header">
    <!-- Logo -->
    <a href="http://larapress.dev" class="logo">
      <!-- mini logo for sidebar mini 50x50 pixels -->
      <span class="logo-mini"><b>LP</b></span>
      <!-- logo for regular state and mobile devices -->
      <span class="logo-lg"><b>LaraPress</b></span>
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top">
      <!-- Sidebar toggle button-->
      <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
        <span class="sr-only">Toggle navigation</span>
      </a>

      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          <!-- User Account: style can be found in dropdown.less -->
          <li class="dropdown user user-menu">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <img src="/themes/Admin_Theme/images/avatar.png" class="user-image" alt="User Image">
              <span class="hidden-xs">User Name</span>
            </a>
            <ul class="dropdown-menu">
              <!-- Menu Footer-->
              <li class="user-footer">
                <div class="pull-right">
                  <a href="http://larapress.dev/logout"
                      onclick="event.preventDefault();
                               document.getElementById('logout-form').submit();" class="btn btn-default btn-flat">
                      Sign out
                  </a>
                  <form id="logout-form" action="http://larapress.dev/logout" method="POST" style="display: none;">
                      <input type="hidden" name="_token" value="3mWSazMe2H65AB2dVXDDZpOIuC7VytM8QcqJOvFq">
                  </form>
                </div>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
  </header>
        <!-- Left side column. contains the logo and sidebar -->
<aside class="main-sidebar">
<!-- sidebar: style can be found in sidebar.less -->
<section class="sidebar">
<!-- Sidebar user panel -->
    <div class="user-panel">
        <div class="pull-left image">
            <img src="/themes/Admin_Theme/images/avatar.png" class="img-circle" alt="User Image">
        </div>
        <div class="pull-left info">
            <p> User Name</p>
            <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
        </div>
    </div>
    <!-- search form -->
    <form action="#" method="get" class="sidebar-form">
        <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Search...">
            <span class="input-group-btn">
                <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i></button>
            </span>
        </div>
    </form>
    <!-- /.search form -->
    <!-- sidebar menu: : style can be found in sidebar.less -->
    <ul class="sidebar-menu">
        <li class="header">MAIN NAVIGATION</li>
        <li class="treeview">
            <a href="/somelink">
            <i class="fa fa-dashboard"></i> <span>Dashboard</span>
            </a>
        </li>
        <li class="treeview">
          <a href="#">
            <i class="fa fa-edit"></i> <span>Blog</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu menu-open" style="display: none;">
            <li><a href="http://larapress.dev/backend/blog"> Posts</a></li>
            <li><a href="http://larapress.dev/backend/blog/create"> Add New</a></li>
            <li><a href="http://larapress.dev/backend/blog/categories"> Categories</a></li>
            <li><a href="http://larapress.dev/backend/blog/tags"> Tags</a></li>
          </ul>
        </li>

    </ul>
</section>
<!-- /.sidebar -->
</aside>
            <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <section class="content-header">
          <h1>
            Blog
            <small>Categories</small>
          </h1>
          <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li><a href="http://larapress.dev/backend/blog"> Blog</a></li>
            <li class="active">Categories</li>
          </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-xs-6">
                  <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">Categories</h3>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <table id="categoriesTable" class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesList">
                                                                    <tr id="row2" data-parent="true" data-children="false">
                                        <td><div id="title2" class="parent category" data-children="false" data-id="2" data-url="http://larapress.dev/backend/blog/categories/get/2" style="color: #3c8dbc; cursor: pointer;">Web Programming5</div></td>
                                        <td style="width: 150px;">
                                            <button id="deleteBtn-2" class="btn btn-xs btn-danger" type="submit"><i class="fa fa-trash"></i> Delete</button>
                                        </td>
                                    </tr>

                                    
                                
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>Title</th>
                                    <th>Actions</th>
                                </tr>
                            </tfoot>
                        </table>
                        
                    </div>
                    <!-- /.box-body -->
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="box">
                    <div class="box-header">
                        <h3 id="actionTitle" class="box-title">Add categories</h3>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <form id="addCategoryForm" action="">
                            <div id="title-form-group" class="form-group">
                                <input type="hidden" name="_token" value="3mWSazMe2H65AB2dVXDDZpOIuC7VytM8QcqJOvFq">
                                <input type="hidden" id="id" name="id" value="">
                                <input type="hidden" id="url" name="url" value="">
                                <label for="title">Title</label>
                                <input type="text" placeholder="Enter category title" value="" id="title" name="title" class="form-control">
                                <span id="title-feedback-block" class="help-block" style="display: none;">
                                    <strong id="title-feedback"></strong>
                                </span>
                            </div>
                            <div id="parent-form-group" class="form-group">
                                <label for="name">Parent</label>
                                <select class="form-control" name="parent" id="parent">
                                    <option value="0">Pick Parent</option>
                                                                            <option value="2">Web Programming5</option>
                                                                    </select>
                            </div>

                            <div class="form-group">
                                <input type="hidden" name="_token" value="3mWSazMe2H65AB2dVXDDZpOIuC7VytM8QcqJOvFq">
                                <label for="title">Description</label> <small>(optional)</small>
                                <textarea id="description" name="description" class="form-control" placeholder="Enter category description"></textarea>
                            </div>
                        </form>

                    </div>
                    
                    <div class="box-footer">
                        <button id="actionCategoryBtn" data-action="create" class="btn btn-primary pull-left" type="submit">Add Category</button>
                        <button id="resetCategoryBtn" class="btn btn-primary pull-right" type="submit" style="display: none">Reset To Add Category</button>
                    </div>
                    <!-- /.box-body -->
                  </div>

                        <div id="category-feedback-info" class="callout callout-info" style="display: none;">
                            <p id="category-feedback-text"></p>
                        </div>

                </div>
            </div>
        </section>
    </div>
        <footer class="main-footer">
    <strong>Powered By <a href="http://larapress.io">Larapress</a> v: <span id="version_footer"></span></strong>
  </footer>
    </div>


    <!-- page script -->
    <script type="text/javascript">
        // Set active state on menu element
        var current_url = "http://larapress.dev/backend/blog/categories";
        console.log(current_url);
        $("ul.sidebar-menu li a").each(function() {
          if (current_url == ($(this).attr('href')))
          {
            $(this).parents('li').addClass('active');
            $(this).parents('ul').attr('style', 'display: block');
          }
        });
    </script>

    <script src="/themes/Admin_Theme/js/app.min.js"></script>

    <script type="text/javascript">
    $(document).ready(function() {

        function initDeleteBtn() {
            $('[id^=deleteBtn-]').unbind();
            $('[id^=deleteBtn-]').on("click", function(event){
                console.log('funny');
                event.preventDefault();
                var id = event.target.id.slice(10);
                swal({
                    title: 'Wait!',
                    text: "Are you sure you want to delete this category and it's children?",
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Delete',
                    allowOutsideClick: false,
                    confirmButtonClass: 'btn btn-success',
                    cancelButtonClass: 'btn btn-danger'
                }).then(function() {
                    $.ajax("http://larapress.dev/backend/blog/categories/delete", {
                        method: 'POST',
                        dataType:'json',
                        data: {
                            id: id,
                            _token: Laravel.csrfToken
                        },
                        success: function(result) {
                            console.log('category deleted');
                            $("#row"+id).remove();

                           $('.child').each(function(i,child){
                                if(id == child.getAttribute("data-parent")){
                                    // console.log("child parent: " + );
                                    child.closest('tr').remove();
                                }
                            });


                        },
                        error: function(result) {
                            var errors = result.responseJSON;
                            console.log(errors);
                            if(typeof errors !== 'undefined') {
                                swal({
                                    type: 'error',
                                    title: errors.message
                                });
                            } else {
                                swal({
                                    type: 'error',
                                    title: 'Something went wrong, category coult not be deleted!'
                                });
                            }
                        }
                    });

                })
            });
        }

        initDeleteBtn();

        function initCategories() {
            $('.category').unbind();
            $('.category').click(function(event) {
                var id = event.target.getAttribute('data-id');
                var url = event.target.getAttribute('data-url');
                var children = event.target.getAttribute('data-children');
                
                $.ajax(url, {
                    method: 'GET',
                    dataType:'json',
                    success: function(result) {
                        console.log("children: " + children);
                        if(children === 'true'){ 
                            $('#parent').empty();
                            $('#parent-form-group').hide();

                        } else {
                            getParents(result.parent, id);
                            $('#parent-form-group').show();
                        }
                        
                        $("#actionTitle").html("Update Category");
                        $("#title").val(result.title);
                        $("#description").val(result.description);
                        $("#id").val(result.id);
                        $("#url").val(url);
                        // if(result.parent == null) {
                        //     $("#parent").val(0);
                        //     console.log('SET PARENT to ZERO');
                        // } else {
                        //     $("#parent").val(result.parent);
                        //     console.log('SET PARENT TO '+result.parent);
                        // }
                        
                        $("#actionCategoryBtn").html("Update Category");
                        $("#actionCategoryBtn").attr("data-action", "update");
                        $("#resetCategoryBtn").show();
                    },
                    error: function(result) {
                        alert('error');
                    }
                });
            });
        }

        initCategories();

        function getParents(parent, exclude) {
            $.ajax("http://larapress.dev/backend/blog/categories/getparents", {
                method: 'GET',
                dataType:'json',
                success: function(result) {
                    $('#parent').empty();
                    var parentCategories = "";
                    parentCategories += '<option value="0">Pick Parent</option>';
                    $.each( result.categories, function( key, value ) {
                        if(key != exclude){
                            parentCategories += '<option value=' + key + '>' + value + '</option>';
                        }
                    });

                    $('#parent').append(parentCategories);

                    if(parent == null || parent == 0) {
                        $("#parent").val(0);
                        console.log("PARENT ZERO");
                    } else {
                        $("#parent").val(parent);
                        console.log("PARENT NOT ZERO " + parent);
                    }

                    
                },
                error: function(result) {
                    alert('error gettings parents');
                }
            });
        }

        $('#resetCategoryBtn').click(function(event) {
            // $('#parent').find('option[value=0]').text('Pick Parent');
            getParents(0, 0);
            $('#parent-form-group').show();
            $("#actionTitle").html("Add Category");
            $("#id").val('');
            $("#title").val('');
            $("#description").val('');
            $("#parent").val(0);
            $("#actionCategoryBtn").attr("data-action", "create");
            $("#actionCategoryBtn").html("Add Category");
            $("#resetCategoryBtn").hide();
        });

        $("#actionCategoryBtn").on("click", function(e){
            var action = e.target.getAttribute('data-action');
            if(action == 'create'){
                $.ajax("http://larapress.dev/backend/blog/categories/create", {
                    method: 'POST',
                    dataType:'json',
                    data: {
                        title: $("#title").val(),
                        description: $("#description").val(),
                        parent: $("#parent").val(),
                        _token: Laravel.csrfToken
                    },
                    success: function(result) {
                            $("#title-form-group").removeClass("has-error");
                            $("#title-feedback-block").hide();
                            $("#title-feedback").html('');

                        var markup = `<tr id="categoryid-`+result.id+`"><td><a href="555">`+$("#title").val()+`</a></td><td> <button id="deleteBtn-`+result.id+`" class="btn btn-xs btn-danger" type="submit"><i class="fa fa-trash"></i> Delete</button> </td></tr>`;

                        if($("#parent").val() != 0){
                            var markup = `<tr id="row`+result.id+`" data-parent="false"><td><div class="child category" data-id=`+result.id+` data-parent=`+$("#parent").val()+` data-url=`+result.url+` style="padding-left: 20px; color: #3c8dbc; cursor: pointer;">`+$("#title").val()+`</div></td><td><button id="deleteBtn-`+result.id+`" class="btn btn-xs btn-danger" type="submit"><i class="fa fa-trash"></i> Delete</button> </td></tr>`;

                            $("#row"+$("#parent").val()).after(markup);
                        } else {
                            var markup = `<tr id="row`+result.id+`" data-parent="false"><td><div class="category" data-id=`+result.id+` data-url=`+result.url+` style="color: #3c8dbc; cursor: pointer;">`+$("#title").val()+`</div></td><td><button id="deleteBtn-`+result.id+`" class="btn btn-xs btn-danger" type="submit"><i class="fa fa-trash"></i> Delete</button> </td></tr>`;
                            $("#categoriesList").prepend(markup);
                        }

                        setTimeout(initDeleteBtn, 100);
                        $("#category-feedback-text").text("Successfully added new category.");
                        $("#category-feedback-info").show().delay(5000).fadeOut();
                    },
                    error: function(result) {
                        var errors = result.responseJSON;
                        if(typeof errors !== 'undefined') {
                            if(typeof errors.title !== 'undefined'){
                                $("#title-form-group").addClass("has-error");
                                $("#title-feedback-block").show();
                                $("#title-feedback").html(errors.title[0]);
                            } else if(typeof errors.message !== 'undefined') {
                                $("#title-form-group").addClass("has-error");
                                $("#title-feedback-block").show();
                                $("#title-feedback").html(errors.message);
                            }
                        }
                    }
                });
            } else if (action == 'update') {
                var testing = $("#parent").val();
                console.log("update parent:" + $("#parent").val());
                $.ajax("http://larapress.dev/backend/blog/categories/update", {
                    method: 'POST',
                    dataType:'json',
                    data: {
                        id: $("#id").val(),
                        title: $("#title").val(),
                        description: $("#description").val(),
                        parent: $("#parent").val(),
                        _token: Laravel.csrfToken
                    },
                    success: function(result) {
                        $("#title-form-group").removeClass("has-error");
                        $("#title-feedback-block").hide();
                        $("#title-feedback").html('');
                        
                        if($("#parent").val() != 0 && $("#parent").val() != null){
                            $("#row"+$("#id").val()).remove();
                            var markup = `<tr id="row`+$("#id").val()+`" data-parent="false"><td><div class="child category" data-id=`+$("#id").val()+` data-parent=`+$("#parent").val()+` data-url=`+$("#url").val()+` style="padding-left: 20px; color: #3c8dbc; cursor: pointer;">`+$("#title").val()+`</div></td><td><button id="deleteBtn-`+result.id+`" class="btn btn-xs btn-danger" type="submit"><i class="fa fa-trash"></i> Delete</button> </td></tr>`;

                            $("#row"+$("#parent").val()).after(markup);
                        } else {
                            console.log("parent no: " +$("#parent").val());
                            var children = $("#row"+$("#id").val()).attr("data-children");
                            if(children) {
                                $("#title"+$("#id").val()).html($("#title").val());
                            }
                            else{
                                var markup = `<tr id="row`+$("#id").val()+`" data-parent="false"><td><div class="category" data-id=`+$("#id").val()+` data-url=`+$("#url").val()+` style="color: #3c8dbc; cursor: pointer;">`+$("#title").val()+`</div></td><td><button id="deleteBtn-`+result.id+`" class="btn btn-xs btn-danger" type="submit"><i class="fa fa-trash"></i> Delete</button> </td></tr>`;
                                $("#categoriesList").append(markup);
                            }
                        }

                        setTimeout(initDeleteBtn, 100);
                        setTimeout(initCategories, 100);

                        getParents($("#parent").val(), $("#id").val());
                        $("#category-feedback-text").text("Successfully updated category.");
                        $("#category-feedback-info").show().delay(5000).fadeOut();


                    },
                    error: function(result) {
                        var errors = result.responseJSON;
                        if(typeof errors !== 'undefined') {
                            if(typeof errors.title !== 'undefined'){
                                $("#title-form-group").addClass("has-error");
                                $("#title-feedback-block").show();
                                $("#title-feedback").html(errors.title[0]);
                            } else if(typeof errors.message !== 'undefined') {
                                $("#title-form-group").addClass("has-error");
                                $("#title-feedback-block").show();
                                $("#title-feedback").html(errors.message);
                            }
                        }
                    }
                });
            }
        });


    });
</script>
</body>
</html>
